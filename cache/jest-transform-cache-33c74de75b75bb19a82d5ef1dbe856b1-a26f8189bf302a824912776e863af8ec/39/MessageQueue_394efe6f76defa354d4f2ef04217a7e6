a1b8c9694b59f3d210384a3b0c7229fe













'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}

var ErrorUtils=require('ErrorUtils');
var Systrace=require('Systrace');

var deepFreezeAndThrowOnMutationInDev=require('deepFreezeAndThrowOnMutationInDev');
var invariant=require('fbjs/lib/invariant');
var stringifySafe=require('stringifySafe');








var TO_JS=0;
var TO_NATIVE=1;

var MODULE_IDS=0;
var METHOD_IDS=1;
var PARAMS=2;
var MIN_TIME_BETWEEN_FLUSHES_MS=5;


var TRACE_TAG_REACT_APPS=1<<17;

var DEBUG_INFO_LIMIT=32;


var JSTimers=null;var

MessageQueue=function(){















function MessageQueue(){_classCallCheck(this,MessageQueue);
this._lazyCallableModules={};
this._queue=[[],[],[],0];
this._successCallbacks=[];
this._failureCallbacks=[];
this._callID=0;
this._lastFlush=0;
this._eventLoopStartTime=new Date().getTime();

if(__DEV__){
this._debugInfo={};
this._remoteModuleTable={};
this._remoteMethodTable={};
}

this.callFunctionReturnFlushedQueue=this.callFunctionReturnFlushedQueue.bind(
this);

this.callFunctionReturnResultAndFlushedQueue=this.callFunctionReturnResultAndFlushedQueue.bind(
this);

this.flushedQueue=this.flushedQueue.bind(this);
this.invokeCallbackAndReturnFlushedQueue=this.invokeCallbackAndReturnFlushedQueue.bind(
this);

}_createClass(MessageQueue,[{key:'callFunctionReturnFlushedQueue',value:function callFunctionReturnFlushedQueue(





















module,method,args){var _this=this;
this.__guard(function(){
_this.__callFunction(module,method,args);
});

return this.flushedQueue();
}},{key:'callFunctionReturnResultAndFlushedQueue',value:function callFunctionReturnResultAndFlushedQueue(


module,
method,
args)
{var _this2=this;
var result=void 0;
this.__guard(function(){
result=_this2.__callFunction(module,method,args);
});

return[result,this.flushedQueue()];
}},{key:'invokeCallbackAndReturnFlushedQueue',value:function invokeCallbackAndReturnFlushedQueue(

cbID,args){var _this3=this;
this.__guard(function(){
_this3.__invokeCallback(cbID,args);
});

return this.flushedQueue();
}},{key:'flushedQueue',value:function flushedQueue()

{var _this4=this;
this.__guard(function(){
_this4.__callImmediates();
});

var queue=this._queue;
this._queue=[[],[],[],this._callID];
return queue[0].length?queue:null;
}},{key:'getEventLoopRunningTime',value:function getEventLoopRunningTime()

{
return new Date().getTime()-this._eventLoopStartTime;
}},{key:'registerCallableModule',value:function registerCallableModule(

name,module){
this._lazyCallableModules[name]=function(){return module;};
}},{key:'registerLazyCallableModule',value:function registerLazyCallableModule(

name,factory){
var module=void 0;
var getValue=factory;
this._lazyCallableModules[name]=function(){
if(getValue){
module=getValue();
getValue=null;
}
return module;
};
}},{key:'getCallableModule',value:function getCallableModule(

name){
var getValue=this._lazyCallableModules[name];
return getValue?getValue():null;
}},{key:'enqueueNativeCall',value:function enqueueNativeCall(


moduleID,
methodID,
params,
onFail,
onSucc)
{
if(onFail||onSucc){
if(__DEV__){
this._debugInfo[this._callID]=[moduleID,methodID];
if(this._callID>DEBUG_INFO_LIMIT){
delete this._debugInfo[this._callID-DEBUG_INFO_LIMIT];
}
}



onFail&&params.push(this._callID<<1);

onSucc&&params.push(this._callID<<1|1);
this._successCallbacks[this._callID]=onSucc;
this._failureCallbacks[this._callID]=onFail;
}

if(__DEV__){
global.nativeTraceBeginAsyncFlow&&
global.nativeTraceBeginAsyncFlow(
TRACE_TAG_REACT_APPS,
'native',
this._callID);

}
this._callID++;

this._queue[MODULE_IDS].push(moduleID);
this._queue[METHOD_IDS].push(methodID);

if(__DEV__){

JSON.stringify(params);


deepFreezeAndThrowOnMutationInDev(params);
}
this._queue[PARAMS].push(params);

var now=new Date().getTime();
if(
global.nativeFlushQueueImmediate&&(
now-this._lastFlush>=MIN_TIME_BETWEEN_FLUSHES_MS||
this._inCall===0))
{
var queue=this._queue;
this._queue=[[],[],[],this._callID];
this._lastFlush=now;
global.nativeFlushQueueImmediate(queue);
}
Systrace.counterEvent('pending_js_to_native_queue',this._queue[0].length);
if(__DEV__&&this.__spy&&isFinite(moduleID)){
this.__spy({
type:TO_NATIVE,
module:this._remoteModuleTable[moduleID],
method:this._remoteMethodTable[moduleID][methodID],
args:params});

}else if(this.__spy){
this.__spy({
type:TO_NATIVE,
module:moduleID+'',
method:methodID,
args:params});

}
}},{key:'createDebugLookup',value:function createDebugLookup(

moduleID,name,methods){
if(__DEV__){
this._remoteModuleTable[moduleID]=name;
this._remoteMethodTable[moduleID]=methods;
}
}},{key:'__guard',value:function __guard(





fn){
this._inCall++;
try{
fn();
}catch(error){
ErrorUtils.reportFatalError(error);
}finally{
this._inCall--;
}
}},{key:'__callImmediates',value:function __callImmediates()

{
Systrace.beginEvent('JSTimers.callImmediates()');
if(!JSTimers){
JSTimers=require('JSTimers');
}
JSTimers.callImmediates();
Systrace.endEvent();
}},{key:'__callFunction',value:function __callFunction(

module,method,args){
this._lastFlush=new Date().getTime();
this._eventLoopStartTime=this._lastFlush;
Systrace.beginEvent(module+'.'+method+'()');
if(this.__spy){
this.__spy({type:TO_JS,module:module,method:method,args:args});
}
var moduleMethods=this.getCallableModule(module);
invariant(
!!moduleMethods,
'Module %s is not a registered callable module (calling %s)',
module,
method);

invariant(
!!moduleMethods[method],
'Method %s does not exist on module %s',
method,
module);

var result=moduleMethods[method].apply(moduleMethods,args);
Systrace.endEvent();
return result;
}},{key:'__invokeCallback',value:function __invokeCallback(

cbID,args){
this._lastFlush=new Date().getTime();
this._eventLoopStartTime=this._lastFlush;



var callID=cbID>>>1;

var isSuccess=cbID&1;
var callback=isSuccess?
this._successCallbacks[callID]:
this._failureCallbacks[callID];

if(__DEV__){
var debug=this._debugInfo[callID];
var _module=debug&&this._remoteModuleTable[debug[0]];
var _method=debug&&this._remoteMethodTable[debug[0]][debug[1]];
if(!callback){
var errorMessage='Callback with id '+cbID+': '+_module+'.'+_method+'() not found';
if(_method){
errorMessage=
'The callback '+_method+'() exists in module '+_module+', '+
'but only one callback may be registered to a function in a native module.';
}
invariant(callback,errorMessage);
}
var profileName=debug?
'<callback for '+_module+'.'+_method+'>':
cbID;
if(callback&&this.__spy){
this.__spy({type:TO_JS,module:null,method:profileName,args:args});
}
Systrace.beginEvent('MessageQueue.invokeCallback('+
profileName+', '+stringifySafe(args)+')');

}

if(!callback){
return;
}

this._successCallbacks[callID]=this._failureCallbacks[callID]=null;
callback.apply(undefined,_toConsumableArray(args));

if(__DEV__){
Systrace.endEvent();
}
}}],[{key:'spy',value:function spy(spyOrToggle){if(spyOrToggle===true){MessageQueue.prototype.__spy=function(info){console.log((info.type===TO_JS?'N->JS':'JS->N')+' : '+(''+(info.module?info.module+'.':'')+info.method)+('('+JSON.stringify(info.args)+')'));};}else if(spyOrToggle===false){MessageQueue.prototype.__spy=null;}else{MessageQueue.prototype.__spy=spyOrToggle;}}}]);return MessageQueue;}();


module.exports=MessageQueue;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIk1lc3NhZ2VRdWV1ZS5qcyJdLCJuYW1lcyI6WyJFcnJvclV0aWxzIiwicmVxdWlyZSIsIlN5c3RyYWNlIiwiZGVlcEZyZWV6ZUFuZFRocm93T25NdXRhdGlvbkluRGV2IiwiaW52YXJpYW50Iiwic3RyaW5naWZ5U2FmZSIsIlRPX0pTIiwiVE9fTkFUSVZFIiwiTU9EVUxFX0lEUyIsIk1FVEhPRF9JRFMiLCJQQVJBTVMiLCJNSU5fVElNRV9CRVRXRUVOX0ZMVVNIRVNfTVMiLCJUUkFDRV9UQUdfUkVBQ1RfQVBQUyIsIkRFQlVHX0lORk9fTElNSVQiLCJKU1RpbWVycyIsIk1lc3NhZ2VRdWV1ZSIsIl9sYXp5Q2FsbGFibGVNb2R1bGVzIiwiX3F1ZXVlIiwiX3N1Y2Nlc3NDYWxsYmFja3MiLCJfZmFpbHVyZUNhbGxiYWNrcyIsIl9jYWxsSUQiLCJfbGFzdEZsdXNoIiwiX2V2ZW50TG9vcFN0YXJ0VGltZSIsIkRhdGUiLCJnZXRUaW1lIiwiX19ERVZfXyIsIl9kZWJ1Z0luZm8iLCJfcmVtb3RlTW9kdWxlVGFibGUiLCJfcmVtb3RlTWV0aG9kVGFibGUiLCJjYWxsRnVuY3Rpb25SZXR1cm5GbHVzaGVkUXVldWUiLCJiaW5kIiwiY2FsbEZ1bmN0aW9uUmV0dXJuUmVzdWx0QW5kRmx1c2hlZFF1ZXVlIiwiZmx1c2hlZFF1ZXVlIiwiaW52b2tlQ2FsbGJhY2tBbmRSZXR1cm5GbHVzaGVkUXVldWUiLCJtb2R1bGUiLCJtZXRob2QiLCJhcmdzIiwiX19ndWFyZCIsIl9fY2FsbEZ1bmN0aW9uIiwicmVzdWx0IiwiY2JJRCIsIl9faW52b2tlQ2FsbGJhY2siLCJfX2NhbGxJbW1lZGlhdGVzIiwicXVldWUiLCJsZW5ndGgiLCJuYW1lIiwiZmFjdG9yeSIsImdldFZhbHVlIiwibW9kdWxlSUQiLCJtZXRob2RJRCIsInBhcmFtcyIsIm9uRmFpbCIsIm9uU3VjYyIsInB1c2giLCJnbG9iYWwiLCJuYXRpdmVUcmFjZUJlZ2luQXN5bmNGbG93IiwiSlNPTiIsInN0cmluZ2lmeSIsIm5vdyIsIm5hdGl2ZUZsdXNoUXVldWVJbW1lZGlhdGUiLCJfaW5DYWxsIiwiY291bnRlckV2ZW50IiwiX19zcHkiLCJpc0Zpbml0ZSIsInR5cGUiLCJtZXRob2RzIiwiZm4iLCJlcnJvciIsInJlcG9ydEZhdGFsRXJyb3IiLCJiZWdpbkV2ZW50IiwiY2FsbEltbWVkaWF0ZXMiLCJlbmRFdmVudCIsIm1vZHVsZU1ldGhvZHMiLCJnZXRDYWxsYWJsZU1vZHVsZSIsImFwcGx5IiwiY2FsbElEIiwiaXNTdWNjZXNzIiwiY2FsbGJhY2siLCJkZWJ1ZyIsImVycm9yTWVzc2FnZSIsInByb2ZpbGVOYW1lIiwic3B5T3JUb2dnbGUiLCJwcm90b3R5cGUiLCJjb25zb2xlIiwibG9nIiwiaW5mbyIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFhQSxhOztBQUVBLEdBQU1BLFlBQWFDLFFBQVEsWUFBUixDQUFuQjtBQUNBLEdBQU1DLFVBQVdELFFBQVEsVUFBUixDQUFqQjs7QUFFQSxHQUFNRSxtQ0FBb0NGLFFBQVEsbUNBQVIsQ0FBMUM7QUFDQSxHQUFNRyxXQUFZSCxRQUFRLG9CQUFSLENBQWxCO0FBQ0EsR0FBTUksZUFBZ0JKLFFBQVEsZUFBUixDQUF0Qjs7Ozs7Ozs7O0FBU0EsR0FBTUssT0FBUSxDQUFkO0FBQ0EsR0FBTUMsV0FBWSxDQUFsQjs7QUFFQSxHQUFNQyxZQUFhLENBQW5CO0FBQ0EsR0FBTUMsWUFBYSxDQUFuQjtBQUNBLEdBQU1DLFFBQVMsQ0FBZjtBQUNBLEdBQU1DLDZCQUE4QixDQUFwQzs7O0FBR0EsR0FBTUMsc0JBQXVCLEdBQUssRUFBbEM7O0FBRUEsR0FBTUMsa0JBQW1CLEVBQXpCOzs7QUFHQSxHQUFJQyxVQUFXLElBQWYsQzs7QUFFTUMsWTs7Ozs7Ozs7Ozs7Ozs7OztBQWdCSix1QkFBYztBQUNaLEtBQUtDLG9CQUFMLENBQTRCLEVBQTVCO0FBQ0EsS0FBS0MsTUFBTCxDQUFjLENBQUMsRUFBRCxDQUFLLEVBQUwsQ0FBUyxFQUFULENBQWEsQ0FBYixDQUFkO0FB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LFVBQVQ7QUFDaUNXLFdBRGpDLE1BQ2lEM0UsY0FBYytCLElBQWQsQ0FEakQ7O0FBR0Q7O0FBRUQsR0FBSSxDQUFDeUMsUUFBTCxDQUFlO0FBQ2I7QUFDRDs7QUFFRCxLQUFLM0QsaUJBQUwsQ0FBdUJ5RCxNQUF2QixFQUFpQyxLQUFLeEQsaUJBQUwsQ0FBdUJ3RCxNQUF2QixFQUFpQyxJQUFsRTtBQUNBRSw0Q0FBWXpDLElBQVo7O0FBRUEsR0FBSVgsT0FBSixDQUFhO0FBQ1h2QixTQUFTcUUsUUFBVDtBQUNEO0FBQ0YsQyxrQ0FsUVVVLFcsQ0FBa0QsQ0FDM0QsR0FBSUEsY0FBZ0IsSUFBcEIsQ0FBMEIsQ0FDeEJsRSxhQUFhbUUsU0FBYixDQUF1QnBCLEtBQXZCLENBQStCLGNBQVEsQ0FDckNxQixRQUFRQyxHQUFSLENBQ0UsQ0FBR0MsS0FBS3JCLElBQUwsR0FBYzFELEtBQWQsQ0FBc0IsT0FBdEIsQ0FBZ0MsT0FBbkMsYUFDSytFLEtBQUtuRCxNQUFMLENBQWNtRCxLQUFLbkQsTUFBTCxDQUFjLEdBQTVCLENBQWtDLEVBRHZDLEVBQzRDbUQsS0FBS2xELE1BRGpELE9BRU1xQixLQUFLQyxTQUFMLENBQWU0QixLQUFLakQsSUFBcEIsQ0FGTixLQURGLEVBS0QsQ0FORCxDQU9ELENBUkQsSUFRTyxJQUFJNkMsY0FBZ0IsS0FBcEIsQ0FBMkIsQ0FDaENsRSxhQUFhbUUsU0FBYixDQUF1QnBCLEtBQXZCLENBQStCLElBQS9CLENBQ0QsQ0FGTSxJQUVBLENBQ0wvQyxhQUFhbUUsU0FBYixDQUF1QnBCLEtBQXZCLENBQStCbUIsV0FBL0IsQ0FDRCxDQUNGLEM7OztBQXVQSC9DLE9BQU9vRCxPQUFQLENBQWlCdkUsWUFBakIiLCJmaWxlIjoiTWVzc2FnZVF1ZXVlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQlNELXN0eWxlIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuIEFuIGFkZGl0aW9uYWwgZ3JhbnRcbiAqIG9mIHBhdGVudCByaWdodHMgY2FuIGJlIGZvdW5kIGluIHRoZSBQQVRFTlRTIGZpbGUgaW4gdGhlIHNhbWUgZGlyZWN0b3J5LlxuICpcbiAqIEBwcm92aWRlc01vZHVsZSBNZXNzYWdlUXVldWVcbiAqIEBmbG93XG4gKiBAZm9ybWF0XG4gKi9cblxuJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBFcnJvclV0aWxzID0gcmVxdWlyZSgnRXJyb3JVdGlscycpO1xuY29uc3QgU3lzdHJhY2UgPSByZXF1aXJlKCdTeXN0cmFjZScpO1xuXG5jb25zdCBkZWVwRnJlZXplQW5kVGhyb3dPbk11dGF0aW9uSW5EZXYgPSByZXF1aXJlKCdkZWVwRnJlZXplQW5kVGhyb3dPbk11dGF0aW9uSW5EZXYnKTtcbmNvbnN0IGludmFyaWFudCA9IHJlcXVpcmUoJ2ZianMvbGliL2ludmFyaWFudCcpO1xuY29uc3Qgc3RyaW5naWZ5U2FmZSA9IHJlcXVpcmUoJ3N0cmluZ2lmeVNhZmUnKTtcblxuZXhwb3J0IHR5cGUgU3B5RGF0YSA9IHtcbiAgdHlwZTogbnVtYmVyLFxuICBtb2R1bGU6ID9zdHJpbmcsXG4gIG1ldGhvZDogc3RyaW5nIHwgbnVtYmVyLFxuICBhcmdzOiBhbnlbXSxcbn07XG5cbmNvbnN0IFRPX0pTID0gMDtcbmNvbnN0IFRPX05BVElWRSA9IDE7XG5cbmNvbnN0IE1PRFVMRV9JRFMgPSAwO1xuY29uc3QgTUVUSE9EX0lEUyA9IDE7XG5jb25zdCBQQVJBTVMgPSAyO1xuY29uc3QgTUlOX1RJTUVfQkVUV0VFTl9GTFVTSEVTX01TID0gNTtcblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWJpdHdpc2VcbmNvbnN0IFRSQUNFX1RBR19SRUFDVF9BUFBTID0gMSA8PCAxNztcblxuY29uc3QgREVCVUdfSU5GT19MSU1JVCA9IDMyO1xuXG4vLyBXb3JrIGFyb3VuZCBhbiBpbml0aWFsaXphdGlvbiBvcmRlciBpc3N1ZVxubGV0IEpTVGltZXJzID0gbnVsbDtcblxuY2xhc3MgTWVzc2FnZVF1ZXVlIHtcbiAgX2xhenlDYWxsYWJsZU1vZHVsZXM6IHtba2V5OiBzdHJpbmddOiAodm9pZCkgPT4gT2JqZWN0fTtcbiAgX3F1ZXVlOiBbbnVtYmVyW10sIG51bWJlcltdLCBhbnlbXSwgbnVtYmVyXTtcbiAgX3N1Y2Nlc3NDYWxsYmFja3M6ICg/RnVuY3Rpb24pW107XG4gIF9mYWlsdXJlQ2FsbGJhY2tzOiAoP0Z1bmN0aW9uKVtdO1xuICBfY2FsbElEOiBudW1iZXI7XG4gIF9pbkNhbGw6IG51bWJlcjtcbiAgX2xhc3RGbHVzaDogbnVtYmVyO1xuICBfZXZlbnRMb29wU3RhcnRUaW1lOiBudW1iZXI7XG5cbiAgX2RlYnVnSW5mbzoge1tudW1iZXJdOiBbbnVtYmVyLCBudW1iZXJdfTtcbiAgX3JlbW90ZU1vZHVsZVRhYmxlOiB7W251bWJlcl06IHN0cmluZ307XG4gIF9yZW1vdGVNZXRob2RUYWJsZToge1tudW1iZXJdOiBzdHJpbmdbXX07XG5cbiAgX19zcHk6ID8oZGF0YTogU3B5RGF0YSkgPT4gdm9pZDtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLl9sYXp5Q2FsbGFibGVNb2R1bGVzID0ge307XG4gICAgdGhpcy5fcXVldWUgPSBbW10sIFtdLCBbXSwgMF07XG4gICAgdGhpcy5fc3VjY2Vzc0NhbGxiYWNrcyA9IFtdO1xuICAgIHRoaXMuX2ZhaWx1cmVDYWxsYmFja3MgPSBbXTtcbiAgICB0aGlzLl9jYWxsSUQgPSAwO1xuICAgIHRoaXMuX2xhc3RGbHVzaCA9IDA7XG4gICAgdGhpcy5fZXZlbnRMb29wU3RhcnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG5cbiAgICBpZiAoX19ERVZfXykge1xuICAgICAgdGhpcy5fZGVidWdJbmZvID0ge307XG4gICAgICB0aGlzLl9yZW1vdGVNb2R1bGVUYWJsZSA9IHt9O1xuICAgICAgdGhpcy5fcmVtb3RlTWV0aG9kVGFibGUgPSB7fTtcbiAgICB9XG5cbiAgICAodGhpczogYW55KS5jYWxsRnVuY3Rpb25SZXR1cm5GbHVzaGVkUXVldWUgPSB0aGlzLmNhbGxGdW5jdGlvblJldHVybkZsdXNoZWRRdWV1ZS5iaW5kKFxuICAgICAgdGhpcyxcbiAgICApO1xuICAgICh0aGlzOiBhbnkpLmNhbGxGdW5jdGlvblJldHVyblJlc3VsdEFuZEZsdXNoZWRRdWV1ZSA9IHRoaXMuY2FsbEZ1bmN0aW9uUmV0dXJuUmVzdWx0QW5kRmx1c2hlZFF1ZXVlLmJpbmQoXG4gICAgICB0aGlzLFxuICAgICk7XG4gICAgKHRoaXM6IGFueSkuZmx1c2hlZFF1ZXVlID0gdGhpcy5mbHVzaGVkUXVldWUuYmluZCh0aGlzKTtcbiAgICAodGhpczogYW55KS5pbnZva2VDYWxsYmFja0FuZFJldHVybkZsdXNoZWRRdWV1ZSA9IHRoaXMuaW52b2tlQ2FsbGJhY2tBbmRSZXR1cm5GbHVzaGVkUXVldWUuYmluZChcbiAgICAgIHRoaXMsXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQdWJsaWMgQVBJc1xuICAgKi9cblxuICBzdGF0aWMgc3B5KHNweU9yVG9nZ2xlOiBib29sZWFuIHwgKChkYXRhOiBTcHlEYXRhKSA9PiB2b2lkKSkge1xuICAgIGlmIChzcHlPclRvZ2dsZSA9PT0gdHJ1ZSkge1xuICAgICAgTWVzc2FnZVF1ZXVlLnByb3RvdHlwZS5fX3NweSA9IGluZm8gPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICBgJHtpbmZvLnR5cGUgPT09IFRPX0pTID8gJ04tPkpTJyA6ICdKUy0+Tid9IDogYCArXG4gICAgICAgICAgICBgJHtpbmZvLm1vZHVsZSA/IGluZm8ubW9kdWxlICsgJy4nIDogJyd9JHtpbmZvLm1ldGhvZH1gICtcbiAgICAgICAgICAgIGAoJHtKU09OLnN0cmluZ2lmeShpbmZvLmFyZ3MpfSlgLFxuICAgICAgICApO1xuICAgICAgfTtcbiAgICB9IGVsc2UgaWYgKHNweU9yVG9nZ2xlID09PSBmYWxzZSkge1xuICAgICAgTWVzc2FnZVF1ZXVlLnByb3RvdHlwZS5fX3NweSA9IG51bGw7XG4gICAgfSBlbHNlIHtcbiAgICAgIE1lc3NhZ2VRdWV1ZS5wcm90b3R5cGUuX19zcHkgPSBzcHlPclRvZ2dsZTtcbiAgICB9XG4gIH1cblxuICBjYWxsRnVuY3Rpb25SZXR1cm5GbHVzaGVkUXVldWUobW9kdWxlOiBzdHJpbmcsIG1ldGhvZDogc3RyaW5nLCBhcmdzOiBhbnlbXSkge1xuICAgIHRoaXMuX19ndWFyZCgoKSA9PiB7XG4gICAgICB0aGlzLl9fY2FsbEZ1bmN0aW9uKG1vZHVsZSwgbWV0aG9kLCBhcmdzKTtcbiAgICB9KTtcblxuICAgIHJldHVybiB0aGlzLmZsdXNoZWRRdWV1ZSgpO1xuICB9XG5cbiAgY2FsbEZ1bmN0aW9uUmV0dXJuUmVzdWx0QW5kRmx1c2hlZFF1ZXVlKFxuICAgIG1vZHVsZTogc3RyaW5nLFxuICAgIG1ldGhvZDogc3RyaW5nLFxuICAgIGFyZ3M6IGFueVtdLFxuICApIHtcbiAgICBsZXQgcmVzdWx0O1xuICAgIHRoaXMuX19ndWFyZCgoKSA9PiB7XG4gICAgICByZXN1bHQgPSB0aGlzLl9fY2FsbEZ1bmN0aW9uKG1vZHVsZSwgbWV0aG9kLCBhcmdzKTtcbiAgICB9KTtcblxuICAgIHJldHVybiBbcmVzdWx0LCB0aGlzLmZsdXNoZWRRdWV1ZSgpXTtcbiAgfVxuXG4gIGludm9rZUNhbGxiYWNrQW5kUmV0dXJuRmx1c2hlZFF1ZXVlKGNiSUQ6IG51bWJlciwgYXJnczogYW55W10pIHtcbiAgICB0aGlzLl9fZ3VhcmQoKCkgPT4ge1xuICAgICAgdGhpcy5fX2ludm9rZUNhbGxiYWNrKGNiSUQsIGFyZ3MpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRoaXMuZmx1c2hlZFF1ZXVlKCk7XG4gIH1cblxuICBmbHVzaGVkUXVldWUoKSB7XG4gICAgdGhpcy5fX2d1YXJkKCgpID0+IHtcbiAgICAgIHRoaXMuX19jYWxsSW1tZWRpYXRlcygpO1xuICAgIH0pO1xuXG4gICAgY29uc3QgcXVldWUgPSB0aGlzLl9xdWV1ZTtcbiAgICB0aGlzLl9xdWV1ZSA9IFtbXSwgW10sIFtdLCB0aGlzLl9jYWxsSURdO1xuICAgIHJldHVybiBxdWV1ZVswXS5sZW5ndGggPyBxdWV1ZSA6IG51bGw7XG4gIH1cblxuICBnZXRFdmVudExvb3BSdW5uaW5nVGltZSgpIHtcbiAgICByZXR1cm4gbmV3IERhdGUoKS5nZXRUaW1lKCkgLSB0aGlzLl9ldmVudExvb3BTdGFydFRpbWU7XG4gIH1cblxuICByZWdpc3RlckNhbGxhYmxlTW9kdWxlKG5hbWU6IHN0cmluZywgbW9kdWxlOiBPYmplY3QpIHtcbiAgICB0aGlzLl9sYXp5Q2FsbGFibGVNb2R1bGVzW25hbWVdID0gKCkgPT4gbW9kdWxlO1xuICB9XG5cbiAgcmVnaXN0ZXJMYXp5Q2FsbGFibGVNb2R1bGUobmFtZTogc3RyaW5nLCBmYWN0b3J5OiB2b2lkID0+IE9iamVjdCkge1xuICAgIGxldCBtb2R1bGU6IE9iamVjdDtcbiAgICBsZXQgZ2V0VmFsdWU6ID8odm9pZCkgPT4gT2JqZWN0ID0gZmFjdG9yeTtcbiAgICB0aGlzLl9sYXp5Q2FsbGFibGVNb2R1bGVzW25hbWVdID0gKCkgPT4ge1xuICAgICAgaWYgKGdldFZhbHVlKSB7XG4gICAgICAgIG1vZHVsZSA9IGdldFZhbHVlKCk7XG4gICAgICAgIGdldFZhbHVlID0gbnVsbDtcbiAgICAgIH1cbiAgICAgIHJldHVybiBtb2R1bGU7XG4gICAgfTtcbiAgfVxuXG4gIGdldENhbGxhYmxlTW9kdWxlKG5hbWU6IHN0cmluZykge1xuICAgIGNvbnN0IGdldFZhbHVlID0gdGhpcy5fbGF6eUNhbGxhYmxlTW9kdWxlc1tuYW1lXTtcbiAgICByZXR1cm4gZ2V0VmFsdWUgPyBnZXRWYWx1ZSgpIDogbnVsbDtcbiAgfVxuXG4gIGVucXVldWVOYXRpdmVDYWxsKFxuICAgIG1vZHVsZUlEOiBudW1iZXIsXG4gICAgbWV0aG9kSUQ6IG51bWJlcixcbiAgICBwYXJhbXM6IGFueVtdLFxuICAgIG9uRmFpbDogP0Z1bmN0aW9uLFxuICAgIG9uU3VjYzogP0Z1bmN0aW9uLFxuICApIHtcbiAgICBpZiAob25GYWlsIHx8IG9uU3VjYykge1xuICAgICAgaWYgKF9fREVWX18pIHtcbiAgICAgICAgdGhpcy5fZGVidWdJbmZvW3RoaXMuX2NhbGxJRF0gPSBbbW9kdWxlSUQsIG1ldGhvZElEXTtcbiAgICAgICAgaWYgKHRoaXMuX2NhbGxJRCA+IERFQlVHX0lORk9fTElNSVQpIHtcbiAgICAgICAgICBkZWxldGUgdGhpcy5fZGVidWdJbmZvW3RoaXMuX2NhbGxJRCAtIERFQlVHX0lORk9fTElNSVRdO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICAvLyBFbmNvZGUgY2FsbElEcyBpbnRvIHBhaXJzIG9mIGNhbGxiYWNrIGlkZW50aWZpZXJzIGJ5IHNoaWZ0aW5nIGxlZnQgYW5kIHVzaW5nIHRoZSByaWdodG1vc3QgYml0XG4gICAgICAvLyB0byBpbmRpY2F0ZSBmYWlsICgwKSBvciBzdWNjZXNzICgxKVxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWJpdHdpc2VcbiAgICAgIG9uRmFpbCAmJiBwYXJhbXMucHVzaCh0aGlzLl9jYWxsSUQgPDwgMSk7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tYml0d2lzZVxuICAgICAgb25TdWNjICYmIHBhcmFtcy5wdXNoKCh0aGlzLl9jYWxsSUQgPDwgMSkgfCAxKTtcbiAgICAgIHRoaXMuX3N1Y2Nlc3NDYWxsYmFja3NbdGhpcy5fY2FsbElEXSA9IG9uU3VjYztcbiAgICAgIHRoaXMuX2ZhaWx1cmVDYWxsYmFja3NbdGhpcy5fY2FsbElEXSA9IG9uRmFpbDtcbiAgICB9XG5cbiAgICBpZiAoX19ERVZfXykge1xuICAgICAgZ2xvYmFsLm5hdGl2ZVRyYWNlQmVnaW5Bc3luY0Zsb3cgJiZcbiAgICAgICAgZ2xvYmFsLm5hdGl2ZVRyYWNlQmVnaW5Bc3luY0Zsb3coXG4gICAgICAgICAgVFJBQ0VfVEFHX1JFQUNUX0FQUFMsXG4gICAgICAgICAgJ25hdGl2ZScsXG4gICAgICAgICAgdGhpcy5fY2FsbElELFxuICAgICAgICApO1xuICAgIH1cbiAgICB0aGlzLl9jYWxsSUQrKztcblxuICAgIHRoaXMuX3F1ZXVlW01PRFVMRV9JRFNdLnB1c2gobW9kdWxlSUQpO1xuICAgIHRoaXMuX3F1ZXVlW01FVEhPRF9JRFNdLnB1c2gobWV0aG9kSUQpO1xuXG4gICAgaWYgKF9fREVWX18pIHtcbiAgICAgIC8vIEFueSBwYXJhbXMgc2VudCBvdmVyIHRoZSBicmlkZ2Ugc2hvdWxkIGJlIGVuY29kYWJsZSBhcyBKU09OXG4gICAgICBKU09OLnN0cmluZ2lmeShwYXJhbXMpO1xuXG4gICAgICAvLyBUaGUgcGFyYW1zIG9iamVjdCBzaG91bGQgbm90IGJlIG11dGF0ZWQgYWZ0ZXIgYmVpbmcgcXVldWVkXG4gICAgICBkZWVwRnJlZXplQW5kVGhyb3dPbk11dGF0aW9uSW5EZXYoKHBhcmFtczogYW55KSk7XG4gICAgfVxuICAgIHRoaXMuX3F1ZXVlW1BBUkFNU10ucHVzaChwYXJhbXMpO1xuXG4gICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgaWYgKFxuICAgICAgZ2xvYmFsLm5hdGl2ZUZsdXNoUXVldWVJbW1lZGlhdGUgJiZcbiAgICAgIChub3cgLSB0aGlzLl9sYXN0Rmx1c2ggPj0gTUlOX1RJTUVfQkVUV0VFTl9GTFVTSEVTX01TIHx8XG4gICAgICAgIHRoaXMuX2luQ2FsbCA9PT0gMClcbiAgICApIHtcbiAgICAgIHZhciBxdWV1ZSA9IHRoaXMuX3F1ZXVlO1xuICAgICAgdGhpcy5fcXVldWUgPSBbW10sIFtdLCBbXSwgdGhpcy5fY2FsbElEXTtcbiAgICAgIHRoaXMuX2xhc3RGbHVzaCA9IG5vdztcbiAgICAgIGdsb2JhbC5uYXRpdmVGbHVzaFF1ZXVlSW1tZWRpYXRlKHF1ZXVlKTtcbiAgICB9XG4gICAgU3lzdHJhY2UuY291bnRlckV2ZW50KCdwZW5kaW5nX2pzX3RvX25hdGl2ZV9xdWV1ZScsIHRoaXMuX3F1ZXVlWzBdLmxlbmd0aCk7XG4gICAgaWYgKF9fREVWX18gJiYgdGhpcy5fX3NweSAmJiBpc0Zpbml0ZShtb2R1bGVJRCkpIHtcbiAgICAgIHRoaXMuX19zcHkoe1xuICAgICAgICB0eXBlOiBUT19OQVRJVkUsXG4gICAgICAgIG1vZHVsZTogdGhpcy5fcmVtb3RlTW9kdWxlVGFibGVbbW9kdWxlSURdLFxuICAgICAgICBtZXRob2Q6IHRoaXMuX3JlbW90ZU1ldGhvZFRhYmxlW21vZHVsZUlEXVttZXRob2RJRF0sXG4gICAgICAgIGFyZ3M6IHBhcmFtcyxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAodGhpcy5fX3NweSkge1xuICAgICAgdGhpcy5fX3NweSh7XG4gICAgICAgIHR5cGU6IFRPX05BVElWRSxcbiAgICAgICAgbW9kdWxlOiBtb2R1bGVJRCArICcnLFxuICAgICAgICBtZXRob2Q6IG1ldGhvZElELFxuICAgICAgICBhcmdzOiBwYXJhbXMsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBjcmVhdGVEZWJ1Z0xvb2t1cChtb2R1bGVJRDogbnVtYmVyLCBuYW1lOiBzdHJpbmcsIG1ldGhvZHM6IHN0cmluZ1tdKSB7XG4gICAgaWYgKF9fREVWX18pIHtcbiAgICAgIHRoaXMuX3JlbW90ZU1vZHVsZVRhYmxlW21vZHVsZUlEXSA9IG5hbWU7XG4gICAgICB0aGlzLl9yZW1vdGVNZXRob2RUYWJsZVttb2R1bGVJRF0gPSBtZXRob2RzO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBQcml2YXRlIG1ldGhvZHNcbiAgICovXG5cbiAgX19ndWFyZChmbjogKCkgPT4gdm9pZCkge1xuICAgIHRoaXMuX2luQ2FsbCsrO1xuICAgIHRyeSB7XG4gICAgICBmbigpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBFcnJvclV0aWxzLnJlcG9ydEZhdGFsRXJyb3IoZXJyb3IpO1xuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLl9pbkNhbGwtLTtcbiAgICB9XG4gIH1cblxuICBfX2NhbGxJbW1lZGlhdGVzKCkge1xuICAgIFN5c3RyYWNlLmJlZ2luRXZlbnQoJ0pTVGltZXJzLmNhbGxJbW1lZGlhdGVzKCknKTtcbiAgICBpZiAoIUpTVGltZXJzKSB7XG4gICAgICBKU1RpbWVycyA9IHJlcXVpcmUoJ0pTVGltZXJzJyk7XG4gICAgfVxuICAgIEpTVGltZXJzLmNhbGxJbW1lZGlhdGVzKCk7XG4gICAgU3lzdHJhY2UuZW5kRXZlbnQoKTtcbiAgfVxuXG4gIF9fY2FsbEZ1bmN0aW9uKG1vZHVsZTogc3RyaW5nLCBtZXRob2Q6IHN0cmluZywgYXJnczogYW55W10pOiBhbnkge1xuICAgIHRoaXMuX2xhc3RGbHVzaCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgIHRoaXMuX2V2ZW50TG9vcFN0YXJ0VGltZSA9IHRoaXMuX2xhc3RGbHVzaDtcbiAgICBTeXN0cmFjZS5iZWdpbkV2ZW50KGAke21vZHVsZX0uJHttZXRob2R9KClgKTtcbiAgICBpZiAodGhpcy5fX3NweSkge1xuICAgICAgdGhpcy5fX3NweSh7dHlwZTogVE9fSlMsIG1vZHVsZSwgbWV0aG9kLCBhcmdzfSk7XG4gICAgfVxuICAgIGNvbnN0IG1vZHVsZU1ldGhvZHMgPSB0aGlzLmdldENhbGxhYmxlTW9kdWxlKG1vZHVsZSk7XG4gICAgaW52YXJpYW50KFxuICAgICAgISFtb2R1bGVNZXRob2RzLFxuICAgICAgJ01vZHVsZSAlcyBpcyBub3QgYSByZWdpc3RlcmVkIGNhbGxhYmxlIG1vZHVsZSAoY2FsbGluZyAlcyknLFxuICAgICAgbW9kdWxlLFxuICAgICAgbWV0aG9kLFxuICAgICk7XG4gICAgaW52YXJpYW50KFxuICAgICAgISFtb2R1bGVNZXRob2RzW21ldGhvZF0sXG4gICAgICAnTWV0aG9kICVzIGRvZXMgbm90IGV4aXN0IG9uIG1vZHVsZSAlcycsXG4gICAgICBtZXRob2QsXG4gICAgICBtb2R1bGUsXG4gICAgKTtcbiAgICBjb25zdCByZXN1bHQgPSBtb2R1bGVNZXRob2RzW21ldGhvZF0uYXBwbHkobW9kdWxlTWV0aG9kcywgYXJncyk7XG4gICAgU3lzdHJhY2UuZW5kRXZlbnQoKTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgX19pbnZva2VDYWxsYmFjayhjYklEOiBudW1iZXIsIGFyZ3M6IGFueVtdKSB7XG4gICAgdGhpcy5fbGFzdEZsdXNoID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgdGhpcy5fZXZlbnRMb29wU3RhcnRUaW1lID0gdGhpcy5fbGFzdEZsdXNoO1xuXG4gICAgLy8gVGhlIHJpZ2h0bW9zdCBiaXQgb2YgY2JJRCBpbmRpY2F0ZXMgZmFpbCAoMCkgb3Igc3VjY2VzcyAoMSksIHRoZSBvdGhlciBiaXRzIGFyZSB0aGUgY2FsbElEIHNoaWZ0ZWQgbGVmdC5cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tYml0d2lzZVxuICAgIGNvbnN0IGNhbGxJRCA9IGNiSUQgPj4+IDE7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWJpdHdpc2VcbiAgICBjb25zdCBpc1N1Y2Nlc3MgPSBjYklEICYgMTtcbiAgICBjb25zdCBjYWxsYmFjayA9IGlzU3VjY2Vzc1xuICAgICAgPyB0aGlzLl9zdWNjZXNzQ2FsbGJhY2tzW2NhbGxJRF1cbiAgICAgIDogdGhpcy5fZmFpbHVyZUNhbGxiYWNrc1tjYWxsSURdO1xuXG4gICAgaWYgKF9fREVWX18pIHtcbiAgICAgIGNvbnN0IGRlYnVnID0gdGhpcy5fZGVidWdJbmZvW2NhbGxJRF07XG4gICAgICBjb25zdCBtb2R1bGUgPSBkZWJ1ZyAmJiB0aGlzLl9yZW1vdGVNb2R1bGVUYWJsZVtkZWJ1Z1swXV07XG4gICAgICBjb25zdCBtZXRob2QgPSBkZWJ1ZyAmJiB0aGlzLl9yZW1vdGVNZXRob2RUYWJsZVtkZWJ1Z1swXV1bZGVidWdbMV1dO1xuICAgICAgaWYgKCFjYWxsYmFjaykge1xuICAgICAgICBsZXQgZXJyb3JNZXNzYWdlID0gYENhbGxiYWNrIHdpdGggaWQgJHtjYklEfTogJHttb2R1bGV9LiR7bWV0aG9kfSgpIG5vdCBmb3VuZGA7XG4gICAgICAgIGlmIChtZXRob2QpIHtcbiAgICAgICAgICBlcnJvck1lc3NhZ2UgPVxuICAgICAgICAgICAgYFRoZSBjYWxsYmFjayAke21ldGhvZH0oKSBleGlzdHMgaW4gbW9kdWxlICR7bW9kdWxlfSwgYCArXG4gICAgICAgICAgICAnYnV0IG9ubHkgb25lIGNhbGxiYWNrIG1heSBiZSByZWdpc3RlcmVkIHRvIGEgZnVuY3Rpb24gaW4gYSBuYXRpdmUgbW9kdWxlLic7XG4gICAgICAgIH1cbiAgICAgICAgaW52YXJpYW50KGNhbGxiYWNrLCBlcnJvck1lc3NhZ2UpO1xuICAgICAgfVxuICAgICAgY29uc3QgcHJvZmlsZU5hbWUgPSBkZWJ1Z1xuICAgICAgICA/ICc8Y2FsbGJhY2sgZm9yICcgKyBtb2R1bGUgKyAnLicgKyBtZXRob2QgKyAnPidcbiAgICAgICAgOiBjYklEO1xuICAgICAgaWYgKGNhbGxiYWNrICYmIHRoaXMuX19zcHkpIHtcbiAgICAgICAgdGhpcy5fX3NweSh7dHlwZTogVE9fSlMsIG1vZHVsZTogbnVsbCwgbWV0aG9kOiBwcm9maWxlTmFtZSwgYXJnc30pO1xuICAgICAgfVxuICAgICAgU3lzdHJhY2UuYmVnaW5FdmVudChcbiAgICAgICAgYE1lc3NhZ2VRdWV1ZS5pbnZva2VDYWxsYmFjaygke3Byb2ZpbGVOYW1lfSwgJHtzdHJpbmdpZnlTYWZlKGFyZ3MpfSlgLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoIWNhbGxiYWNrKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5fc3VjY2Vzc0NhbGxiYWNrc1tjYWxsSURdID0gdGhpcy5fZmFpbHVyZUNhbGxiYWNrc1tjYWxsSURdID0gbnVsbDtcbiAgICBjYWxsYmFjayguLi5hcmdzKTtcblxuICAgIGlmIChfX0RFVl9fKSB7XG4gICAgICBTeXN0cmFjZS5lbmRFdmVudCgpO1xuICAgIH1cbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE1lc3NhZ2VRdWV1ZTtcbiJdfQ==